╔═══════════════════════════════════════════════════════════════════════════════╗
║                       OCR API - SECURITY ARCHITECTURE                         ║
╚═══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│ CLIENT UPLOAD                                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
        ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
        ┃         POST /api/upload (route.ts)                ┃
        ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
            ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
            │ Check File  │ │  Validate   │ │  Validate   │
            │   Exists    │ │ Form Fields │ │  Webhook    │
            └─────────────┘ └─────────────┘ └─────────────┘
                    │               │               │
                    │         ✓ Email      ✓ No Private IPs
                    │         ✓ Type       ✓ HTTPS (prod)
                    │               │               │
                    └───────────────┴───────────────┘
                                    │
                                    ▼
                        ┌──────────────────────┐
                        │ Convert to Buffer    │
                        │   (In-Memory)        │
                        └──────────────────────┘
                                    │
                                    ▼
        ╔════════════════════════════════════════════════════╗
        ║     FileValidationService.validateFile()          ║
        ╠════════════════════════════════════════════════════╣
        ║                                                    ║
        ║  [1] File Size Check                              ║
        ║      └─ Max 50MB                                  ║
        ║                                                    ║
        ║  [2] Magic Number Detection 🔍                    ║
        ║      └─ Read binary signature                     ║
        ║      └─ Detect actual file type                   ║
        ║      └─ Cannot be spoofed!                        ║
        ║                                                    ║
        ║  [3] Type Verification                            ║
        ║      └─ Is detected type allowed?                 ║
        ║                                                    ║
        ║  [4] Claimed vs Detected Match                    ║
        ║      └─ Client said PNG, is it really PNG?        ║
        ║                                                    ║
        ║  [5] Type-Specific Validation                     ║
        ║      ┌──────────────────────────────────┐         ║
        ║      │ IF IMAGE:                        │         ║
        ║      │  ├─ Sharp metadata check         │         ║
        ║      │  ├─ Dimension ≤ 50,000px         │         ║
        ║      │  ├─ Pixels ≤ 178 million  💣     │         ║
        ║      │  ├─ Test decompression           │         ║
        ║      │  └─ Compression ratio check      │         ║
        ║      └──────────────────────────────────┘         ║
        ║      ┌──────────────────────────────────┐         ║
        ║      │ IF PDF:                          │         ║
        ║      │  ├─ Parse with pdf-lib           │         ║
        ║      │  ├─ Reject if encrypted 🔒       │         ║
        ║      │  ├─ Scan for JavaScript ⚠️       │         ║
        ║      │  ├─ Scan for embedded files      │         ║
        ║      │  └─ Pages ≤ 500                  │         ║
        ║      └──────────────────────────────────┘         ║
        ║                                                    ║
        ╚════════════════════════════════════════════════════╝
                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
            ┌─────────────┐                 ┌─────────────┐
            │   INVALID   │                 │    VALID    │
            │  Return 400 │                 │ Continue... │
            └─────────────┘                 └─────────────┘
                                                    │
                                                    ▼
                                    ┌───────────────────────────┐
                                    │ Save to PostgreSQL         │
                                    │ - Sanitized buffer         │
                                    │ - Detected type (not user) │
                                    │ - Status: PENDING          │
                                    └───────────────────────────┘
                                                    │
                                                    ▼
                                    ┌───────────────────────────┐
                                    │ Return Job ID              │
                                    │ { id: "uuid...",          │
                                    │   status: "PENDING" }     │
                                    └───────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ BACKGROUND WORKER                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌──────────────────────┐
                        │ Poll for PENDING jobs │
                        │ (every 5 seconds)     │
                        └──────────────────────┘
                                    │
                                    ▼
                        ┌──────────────────────┐
                        │ Lock job (PROCESSING)│
                        └──────────────────────┘
                                    │
                                    ▼
        ╔════════════════════════════════════════════════════╗
        ║   DEFENSE IN DEPTH: Re-validate File               ║
        ║   (protects against DB corruption/injection)       ║
        ╚════════════════════════════════════════════════════╝
                                    │
                        ┌───────────┴───────────┐
                        ▼                       ▼
                ┌─────────────┐         ┌─────────────┐
                │  INVALID    │         │    VALID    │
                │ Mark FAILED │         │   Process   │
                └─────────────┘         └─────────────┘
                                                │
                                                ▼
                        ╔═══════════════════════════════════╗
                        ║  Process with Timeout Protection  ║
                        ║                                   ║
                        ║  Promise.race([                   ║
                        ║    ocrService.processDocument(),  ║
                        ║    timeout(5 minutes) ⏱️         ║
                        ║  ])                               ║
                        ╚═══════════════════════════════════╝
                                                │
                                ┌───────────────┴───────────────┐
                                ▼                               ▼
                        ┌─────────────┐                 ┌─────────────┐
                        │   TIMEOUT   │                 │   SUCCESS   │
                        │ Mark FAILED │                 │Mark COMPLETED│
                        └─────────────┘                 └─────────────┘
                                                                │
                                                                ▼
                                                    ┌──────────────────┐
                                                    │ Webhook Callback?│
                                                    └──────────────────┘
                                                                │
                                                        ┌───────┴───────┐
                                                        ▼               ▼
                                                    ┌──────┐        ┌──────┐
                                                    │  Yes │        │  No  │
                                                    └──────┘        └──────┘
                                                        │               │
                                                        ▼               │
                                            ┌──────────────────────┐   │
                                            │ POST to Webhook URL  │   │
                                            │ { jobId, ocrResult } │   │
                                            └──────────────────────┘   │
                                                        │               │
                                                        └───────┬───────┘
                                                                ▼
                                                            ┌────────┐
                                                            │  Done  │
                                                            └────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ SECURITY LAYERS                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ ✅ Layer 1: Form Validation (email, documentType, webhook URL)              │
│ ✅ Layer 2: File Validation (magic numbers, size, type)                     │
│ ✅ Layer 3: Content Validation (image bombs, malicious PDFs)                │
│ ✅ Layer 4: SSRF Protection (webhook URL filtering)                         │
│ ✅ Layer 5: Re-validation in Worker (defense in depth)                      │
│ ✅ Layer 6: Timeout Protection (resource limits)                            │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ ATTACKS BLOCKED                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ 🛡️  MIME Type Spoofing        → Magic number detection                     │
│ 🛡️  Image/Zip Bombs            → Pixel count + dimension limits            │
│ 🛡️  Malicious PDFs             → JavaScript/embed detection                │
│ 🛡️  SSRF Attacks               → Private IP blocking                       │
│ 🛡️  Resource Exhaustion        → File size + timeout limits                │
│ 🛡️  Corrupted Files            → Structure validation                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ STILL NEEDED FOR PRODUCTION                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ ❌ Authentication (API keys/JWT)                                             │
│ ❌ Rate Limiting (per user/IP)                                               │
│ ❌ Authorization (job ownership)                                             │
│ ❌ HTTPS/TLS (encrypted transit)                                             │
│ ❌ Webhook Signatures (HMAC)                                                 │
│ ❌ Audit Logging                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
